{% extends 'admin/_layout.html.twig' %}

{% block title %}Administration - {{ event ? event.name : 'Aucun √©v√©nement' }}{% endblock %}

{% block admin_body %}
<div class="grid md:grid-cols-3 gap-6" {{ stimulus_controller('dashboard', {
    eventId: event ? event.id : null,
    gameId: current ? current.id : null,
    mercureUrl: app.request.server.get('MERCURE_PUBLIC_URL'),
    toggleUrl: current ? path('admin_toggle_number', {id: current.id, number: 0}) : null,
    potentialsFragmentUrl: current ? path('admin_game_potentials_fragment', {id: current.id}) : null
}) }}>
    <div class="md:col-span-2 bg-white rounded shadow p-6">
        <div class="flex items-center justify-between mb-2">
            <h1 class="text-2xl font-bold">{{ event ? (event.name ~ ' ‚Äì ' ~ (event.date|date('d/m/Y'))) : 'Aucun √©v√©nement' }}</h1>
            <div class="space-x-2">
                <a href="{{ path('admin_event_index') }}" class="px-3 py-1 bg-gray-200 rounded">√âv√©nements</a>
                <a href="{{ path('admin_player_index') }}" class="px-3 py-1 bg-gray-200 rounded">Joueurs</a>
                <a href="{{ path('admin_card_index') }}" class="px-3 py-1 bg-gray-200 rounded">Cartons</a>
                <a href="{{ path('admin_card_index') }}" class="px-3 py-1 bg-gray-200 rounded">Cartons</a>
            </div>
        </div>
        {% if current %}
            <div class="flex flex-wrap items-center gap-4 mb-4">
                <div><span class="font-semibold">Partie courante:</span> #{{ current.position }} ({{ current.rule.value }}) ‚Äì Lot: {{ current.prize }} ‚Äì Statut: <span class="px-2 py-1 rounded text-white {{ current.status.value == 'RUNNING' ? 'bg-green-600' : (current.status.value == 'FINISHED' ? 'bg-gray-600' : 'bg-amber-600') }}">{{ current.status.value }}</span></div>
                <form method="post" action="{{ path('admin_game_start', {id: current.id}) }}"><button class="px-3 py-1 bg-blue-600 text-white rounded">D√©marrer</button></form>
                <form method="post" action="{{ path('admin_game_finish', {id: current.id}) }}"><button class="px-3 py-1 bg-gray-700 text-white rounded">Terminer</button></form>
                <form method="post" action="{{ path('admin_game_next', {id: current.id}) }}"><button class="px-3 py-1 bg-purple-700 text-white rounded">Partie suivante</button></form>
                <form method="post" action="{{ path('admin_game_demarque', {id: current.id}) }}"><button class="px-3 py-1 bg-amber-700 text-white rounded">D√©marque (reset)</button></form>
                {% if current.isFrozen %}
                    <form method="post" action="{{ path('admin_game_unfreeze', {id: current.id}) }}" id="unfreeze-form"><button type="submit" class="px-3 py-1 bg-red-600 text-white rounded">üîì D√©geler la partie</button></form>
                {% endif %}
            </div>

            {# Alertes tableau de bord #}
            <div class="space-y-2 mb-4">
                {% if current.isFrozen %}
                    <div class="p-3 rounded bg-red-100 text-red-900 font-semibold">‚ö†Ô∏è Cette partie est gel√©e. Les tirages ne sont pas autoris√©s.</div>
                {% endif %}
                {% if current.status.value != 'RUNNING' %}
                    <div class="p-3 rounded bg-amber-100 text-amber-900">Aucune partie en cours. D√©marrez une partie pour activer le tirage.</div>
                {% endif %}
                {% if (cards_count ?? 0) == 0 %}
                    <div class="p-3 rounded bg-blue-100 text-blue-900">Aucun carton enregistr√© pour cet √©v√©nement. <a href="{{ path('admin_card_index') }}" class="underline">Enregistrer un carton</a>.</div>
                {% endif %}
                {% set potentials_count = potentials|length %}
                {% set validated_count = current.winners|length %}
                {% if potentials_count > 0 and validated_count == 0 %}
                    <div class="p-3 rounded bg-indigo-100 text-indigo-900">Des gagnants potentiels existent mais aucun gagnant n'est valid√©.</div>
                {% endif %}
            </div>

            {# KPIs #}
            {% set draws_count = current.draws|length %}
            <div class="grid grid-cols-3 gap-3 mb-4">
                <div class="p-3 rounded border bg-gray-50">
                    <div class="text-xs text-gray-500">Tirages</div>
                    <div {{ stimulus_target('dashboard', 'draws') }} class="text-2xl font-bold">{{ draws_count }}</div>
                </div>
                <div class="p-3 rounded border bg-gray-50">
                    <div class="text-xs text-gray-500">Progression</div>
                    <div {{ stimulus_target('dashboard', 'progression') }} class="text-2xl font-bold">{{ draws_count }}/90</div>
                </div>
                <div class="p-3 rounded border bg-gray-50">
                    <div class="text-xs text-gray-500">Potentiels</div>
                    <div {{ stimulus_target('dashboard', 'potentials') }} class="text-2xl font-bold">{{ potentials_count }}</div>
                </div>
            </div>

            <h2 class="text-xl font-semibold mb-2">Grille des tirages (1‚Äì90)</h2>
            <div class="flex items-center justify-between mb-2">
                {% set last = current.draws|length > 0 ? (current.draws|last).number : null %}
                <div class="text-sm text-gray-600">Dernier num√©ro:
                    <span {{ stimulus_target('dashboard', 'lastNumber') }} class="inline-block px-2 py-1 rounded {{ last ? 'bg-amber-600 text-white' : 'bg-gray-200' }}">{{ last ?? '‚Äî' }}</span>
                </div>
                <div class="text-sm text-gray-600">Mercure: <span {{ stimulus_target('dashboard', 'mercureStatus') }} class="px-2 py-0.5 rounded bg-gray-300">‚Ä¶</span></div>
            </div>
            <div {{ stimulus_target('dashboard', 'grid') }} class="grid grid-cols-10 gap-2 mb-4">
                {% set drawn = current.draws|map(d => d.number)|default([]) %}
                {% for n in 1..90 %}
                    {% set isDrawn = current.draws|filter(d => d.number == n)|length > 0 %}
                    <button data-number="{{ n }}" class="cell px-2 py-2 rounded border text-center {{ isDrawn ? 'bg-green-600 text-white' : 'bg-white' }}">{{ n }}</button>
                {% endfor %}
            </div>

            <h2 class="text-xl font-semibold mb-2">Gagnants potentiels</h2>
            <div {{ stimulus_target('dashboard', 'potentialsContainer') }}>
                {% include 'admin/_potentials_list.html.twig' %}
            </div>

            <div class="mt-6 border-t pt-4">
                <h2 class="text-xl font-semibold mb-2">Gagnants d√©clar√©s</h2>
                {% if current.winners is empty %}
                    <p class="text-gray-500">Aucun gagnant d√©clar√©.</p>
                {% else %}
                    <ul class="list-disc ml-6">
                        {% for w in current.winners %}
                            <li>
                                {{ w.source.value }} ‚Äì {{ w.reference ?? '‚Äî' }}{% if w.card %} ¬∑ Carton {{ w.card.reference }}{% endif %} ¬∑ <span class="text-xs text-gray-500">{{ w.createdAt|date('H:i:s') }}</span>
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}

                {% if winner_form is defined and winner_form %}
                    <div class="mt-4">
                        <h3 class="font-semibold mb-2">D√©clarer un gagnant (OFFLINE)</h3>
                        {{ form_start(winner_form, { action: path('admin_winner_offline', {id: current.id}) }) }}
                            <div class="flex flex-col md:flex-row gap-2 items-end">
                                <div class="grow">{{ form_row(winner_form.reference) }}</div>
                                <div class="grow">{{ form_row(winner_form.card) }}</div>
                                <div><button class="px-3 py-2 bg-green-700 text-white rounded">Enregistrer</button></div>
                            </div>
                        {{ form_end(winner_form) }}
                    </div>
                {% endif %}
            </div>
        {% else %}
            <p>Aucune partie d√©finie.</p>
        {% endif %}
    </div>

    <div class="bg-white rounded shadow p-6">
        <h2 class="text-xl font-semibold mb-2">Parties</h2>
        <ul class="space-y-2" {{ stimulus_controller('sortable', { url: path('admin_game_reorder') }) }}>
            {% for g in games %}
                <li data-id="{{ g.id }}" class="flex items-center justify-between p-2 border rounded cursor-move {{ (current and g.id == current.id) ? 'bg-amber-50' : 'bg-white' }}">
                    <div>
                        <span class="text-gray-400 mr-2">‚ò∞</span>
                        #{{ g.position }} ‚Äì {{ ('app.rules.' ~ g.rule.value)|trans }} ‚Äì {{ g.prize }}
                        <span class="ml-2 text-xs px-2 py-0.5 rounded {{ g.status.value == 'RUNNING' ? 'bg-green-600 text-white' : (g.status.value == 'FINISHED' ? 'bg-gray-600 text-white' : 'bg-amber-600 text-white') }}">{{ g.status.value|trans }}</span>
                    </div>
                    <form method="post" action="{{ path('admin_game_start', {id: g.id}) }}"><button class="px-2 py-1 text-sm bg-blue-600 text-white rounded">Basculer</button></form>
                </li>
            {% endfor %}
        </ul>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ parent() }}
<script>
{% if current %}
// Confirm demarque
const demarqueForm = document.querySelector('form[action="{{ path('admin_game_demarque', {id: current.id}) }}"]');
if (demarqueForm) {
  demarqueForm.addEventListener('submit', function(e){
    if (!confirm('Confirmer la d√©marque (r√©initialiser tous les tirages) ?')) {
      e.preventDefault();
    }
  });
}
{% endif %}
</script>
{% endblock %}
